<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>處方加給計算機（自訂上班人次）</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --line:#23304e; --text:#eaf1ff; --muted:#8aa0c7;
      --ok:#7ee3b7; --warn:#ffd27a; --danger:#ffb4b4;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Microsoft JhengHei","PingFang TC","Noto Sans TC",sans-serif;}
    body{margin:0;background:linear-gradient(180deg,#070b14,#0b1220);color:var(--text);}
    .wrap{max-width:1250px;margin:18px auto;padding:0 12px 40px;}
    h1{font-size:20px;margin:0 0 10px;}
    .sub{color:var(--muted);font-size:12px;line-height:1.6;margin-bottom:14px;}
    .card{background:rgba(17,26,46,.92);border:1px solid var(--line);border-radius:14px;padding:14px;}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;}
    button{
      cursor:pointer;background:#142044;color:var(--text);
      border:1px solid var(--line);border-radius:10px;padding:10px 12px;
    }
    button.primary{background:#1b2d63;border-color:#2a3e7e;}
    button:hover{filter:brightness(1.08);}
    .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted);}
    .pill.ok{color:var(--ok);}
    .pill.warn{color:var(--warn);}
    .pill.danger{color:var(--danger);}

    table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed;}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:13px;vertical-align:top;}
    th{color:var(--muted);font-weight:650;}
    select,input{
      width:100%;padding:10px 10px;border-radius:10px;border:1px solid var(--line);
      background:#0b1326;color:var(--text);outline:none;
    }
    input:focus,select:focus{border-color:#3a4e7a;}

    .mini{color:var(--muted);font-size:12px;line-height:1.6;margin-top:8px;}
    .note{color:var(--muted);font-size:12px;margin-top:10px;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;}

    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
    .quickbar{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;}
    .qbtn{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0b1326;}
    .qbtn:hover{filter:brightness(1.08);}
    .qbtn.small{padding:9px 10px;font-size:13px;color:var(--text);}

    .summaryBox{
      background:#0b1326;border:1px solid var(--line);border-radius:12px;
      padding:10px; line-height:1.65; word-break:break-word;
    }
    .summaryBox.invalid{
      border-color:var(--danger);
      box-shadow:0 0 0 1px rgba(255,180,180,.25) inset;
    }
    .dangerText{color:var(--danger);}

    .kv{display:grid;grid-template-columns:120px 1fr;gap:6px;margin-top:8px;}
    .kv .k{color:var(--muted);}
    .kv .v b{color:var(--text);}

    .row-actions{display:flex;gap:8px;justify-content:flex-end;}
    .row-actions button{padding:8px 10px;}

    .invalidField{border-color:var(--danger)!important;}
    .inlineReason{margin-top:6px;color:var(--danger);font-size:12px;line-height:1.5;}

    .sublist{margin-top:6px;padding-left:16px;color:var(--muted);font-size:12px;line-height:1.7;}
    .sublist b{color:var(--text);}

    /* ---------- Mobile-first enhancements ---------- */
    @media (max-width: 860px){
      .wrap{padding:0 10px 40px;}
      .toolbar{gap:8px;}
      .toolbar button{flex:1 1 160px;}
      .pill{width:100%;text-align:center;}
      .quickbar .qbtn{flex:1 1 calc(50% - 6px);} /* 2 per row */
      /* Bigger touch targets + avoid iOS zoom */
      input, select, button { font-size:16px; }
      button { padding:12px 12px; }
      .qbtn.small{font-size:15px;}
    }

    /* Turn table into cards on small screens */
    @media (max-width: 720px){
      table, thead, tbody, th, td, tr { display:block; }
      thead { display:none; }
      tbody tr{
        border:1px solid var(--line);
        background:rgba(17,26,46,.6);
        border-radius:14px;
        margin:12px 0;
        overflow:hidden;
      }
      tbody tr td{
        border-bottom:1px solid var(--line);
        padding:12px 12px;
      }
      tbody tr td:last-child{ border-bottom:none; }

      tbody tr td[data-label]::before{
        content: attr(data-label);
        display:block;
        color: var(--muted);
        font-size:12px;
        margin-bottom:8px;
      }

      .kv{grid-template-columns:1fr;}
      .kv .k{margin-top:8px;}
      .row-actions{justify-content:flex-start;}
      .row-actions button{width:100%;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>處方加給計算機（自訂上班人次）</h1>
    <div class="sub">
      每一列代表一個診次（早/午/晚可任意新增）。你可指定：<b>醫師數（1=單診、2=雙診）</b>、<b>藥師/助理/工讀上班人次</b>、處方張數。<br/>
      若配置不符合補助原則，或符合限制（<b>晚診 + 雙診 + 總人數=2</b>），該診顯示 <b class="dangerText">不符合規則</b> 且不計算。
    </div>

    <div class="card">
      <div class="toolbar">
        <button class="primary" id="addRowBtn" type="button">新增一診</button>
        <button id="add3Btn" type="button">一鍵新增：早/午/晚</button>
        <button id="clearBtn" type="button">清空</button>
        <button id="copyLinkBtn" type="button">複製分享連結（帶參數）</button>
        <span class="pill">超額單價：助理 5 / 張、藥師 10 / 張</span>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:90px;">診次</th>
            <th style="width:95px;">醫師數</th>
            <th style="width:320px;">當日上班人次（含快速套用）</th>
            <th style="width:120px;">處方張數</th>
            <th>結果（藥師/助理津貼明細）</th>
            <th style="width:90px;"></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="note">
        <b>補助原則（原始規則）</b>
        <div class="mini">
          - 單診（醫師 1 位）：必須 <span class="mono">1 藥師 + 1 助理 + 0 工讀</span><br/>
          - 雙診（醫師 2 位）：允許三種之一：<br/>
          &nbsp;&nbsp;A) <span class="mono">1 藥師 + 1 助理 + 0 工讀</span><br/>
          &nbsp;&nbsp;B) <span class="mono">2 藥師 + 0 助理 + 0 工讀</span><br/>
          &nbsp;&nbsp;C) <span class="mono">1 藥師 + 1 助理 + 1 工讀</span><br/><br/>
          <b>你的限制</b><br/>
          - 只有 <b>晚診</b> 且為 <b>雙診（醫師=2）</b>，同時上班總人數 <span class="mono">(藥師+助理+工讀)=2</span> → <b class="dangerText">不符合規則</b>（不計算）。<br/>
          - <b>午診</b> 雙診 2 人則允許（仍需符合 A 或 B 其一）。
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- Utils ----------
  function moneyPlain(n){
    const v = Math.round((Number(n) || 0));
    return v.toLocaleString("zh-Hant-TW");
  }
  function encodeData(obj){
    const json = JSON.stringify(obj);
    return btoa(unescape(encodeURIComponent(json)));
  }
  function decodeData(b64){
    const json = decodeURIComponent(escape(atob(b64)));
    return JSON.parse(json);
  }
  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      window.prompt("已產生分享連結，請複製：", text);
      return false;
    }
  }

  // ---------- Rules ----------
  function getRuleByStaff(doctors, p, a, t){
    const base = { valid:false, threshold:0, stipendA:0, stipendPEach:0, key:"", label:"" };

    if (doctors === 1){
      if (p === 1 && a === 1 && t === 0){
        return { valid:true, key:"SINGLE_1P1A", threshold:40, stipendA:0, stipendPEach:0,
          label:"單診：門檻40；第41張起 助理5/張、藥師10/張；無固定津貼" };
      }
      return { ...base, label:"單診必須是 1 藥師 + 1 助理（工讀=0）。" };
    }

    if (doctors === 2){
      if (p === 1 && a === 1 && t === 0){
        return { valid:true, key:"DOUBLE_A_1P1A", threshold:50, stipendA:250, stipendPEach:500,
          label:"雙診1藥1助：助理固定250、藥師固定500；門檻50；第51張起 助理5/張、藥師10/張" };
      }
      if (p === 2 && a === 0 && t === 0){
        return { valid:true, key:"DOUBLE_B_2P", threshold:50, stipendA:0, stipendPEach:500,
          label:"雙診2藥：每位藥師固定500；門檻50；第51張起 藥師10/張（以人次倍計）" };
      }
      if (p === 1 && a === 1 && t === 1){
        return { valid:true, key:"DOUBLE_C_1P1A1T", threshold:60, stipendA:300, stipendPEach:500,
          label:"雙診1藥1助1工：助理固定300、藥師固定500；門檻60；第61張起 助理5/張、藥師10/張（工讀=0）" };
      }
      return { ...base, label:"雙診配置不符合三種補助原則（雙診1藥1助 / 雙診2藥 / 雙診1藥1助1工）。" };
    }

    return { ...base, label:"醫師數請選 1 或 2。" };
  }

  function computeRow(tr){
    const shift = tr.querySelector(".shift").value;     // 早/午/晚
    const doctors = Number(tr.querySelector(".doctors").value); // 1/2
    const p = Number(tr.querySelector(".pCount").value || 0);
    const a = Number(tr.querySelector(".aCount").value || 0);
    const t = Number(tr.querySelector(".tCount").value || 0);
    const rx = Number(tr.querySelector(".rx").value || 0);

    // 修正後限制：只有「晚診 + 雙診 + 總人數=2」不符合
    const headcount = p + a + t;
    if (shift === "晚" && doctors === 2 && headcount === 2){
      return {
        valid:false,
        reason:"晚診為雙診時，上班人數只有 2 人，依規則視為不符合。",
        ruleKey:"",
        threshold:0, over:0,
        p, a, t,
        pSession:0, pRx:0, aSession:0, aRx:0
      };
    }

    const rule = getRuleByStaff(doctors, p, a, t);
    if (!rule.valid){
      return {
        valid:false, reason:rule.label,
        ruleKey: rule.key || "",
        threshold:0, over:0,
        p, a, t,
        pSession:0, pRx:0, aSession:0, aRx:0
      };
    }

    const over = Math.max(0, rx - rule.threshold);

    // 工讀固定 0，不顯示
    const aSession = rule.stipendA * a;
    const aRx = over * 5 * a;

    const pSession = rule.stipendPEach * p;
    const pRx = over * 10 * p;

    return {
      valid:true,
      ruleLabel:rule.label,
      ruleKey: rule.key,
      threshold:rule.threshold,
      over,
      p, a, t,
      pSession, pRx,
      aSession, aRx
    };
  }

  // ---------- UI ----------
  const tbody = document.getElementById("tbody");
  const addRowBtn = document.getElementById("addRowBtn");
  const add3Btn = document.getElementById("add3Btn");
  const clearBtn = document.getElementById("clearBtn");
  const copyLinkBtn = document.getElementById("copyLinkBtn");

  function setStaff(tr, doctors, p, a, t){
    tr.querySelector(".doctors").value = String(doctors);
    tr.querySelector(".pCount").value = String(p);
    tr.querySelector(".aCount").value = String(a);
    tr.querySelector(".tCount").value = String(t);
  }

  function clearInvalidStyles(tr){
    ["doctors","pCount","aCount","tCount"].forEach(cls=>{
      const el = tr.querySelector("." + cls);
      if (el) el.classList.remove("invalidField");
    });
    const reason = tr.querySelector(".inlineReason");
    if (reason) reason.textContent = "";
  }

  function applyInvalidStyles(tr, reasonText){
    ["doctors","pCount","aCount","tCount"].forEach(cls=>{
      const el = tr.querySelector("." + cls);
      if (el) el.classList.add("invalidField");
    });
    const reason = tr.querySelector(".inlineReason");
    if (reason) reason.textContent = reasonText || "不符合規則";
  }

  function renderRow(tr){
    const c = computeRow(tr);
    const cell = tr.querySelector(".result");

    clearInvalidStyles(tr);

    if (!c.valid){
      cell.innerHTML = `
        <div class="summaryBox invalid">
          <div class="pill danger">不符合規則</div>
          <div class="mini" style="margin-top:8px;">${c.reason}</div>
        </div>
      `;
      applyInvalidStyles(tr, c.reason);
      return;
    }

    const pillClass = (c.over > 0) ? "pill warn" : "pill ok";

    // 雙診2藥：顯示每位藥師明細
    const isTwoPharmacists = (c.ruleKey === "DOUBLE_B_2P" && c.p === 2 && c.a === 0 && c.t === 0);
    let pharmacistHtml = "";

    if (isTwoPharmacists){
      const eachSession = 500;
      const eachRx = c.over * 10;
      pharmacistHtml = `
        <div class="kv">
          <div class="k">藥師1</div>
          <div class="v">每節津貼 <b>${moneyPlain(eachSession)}</b> 元；處方津貼 <b>${moneyPlain(eachRx)}</b> 元</div>

          <div class="k">藥師2</div>
          <div class="v">每節津貼 <b>${moneyPlain(eachSession)}</b> 元；處方津貼 <b>${moneyPlain(eachRx)}</b> 元</div>
        </div>
      `;
    } else {
      pharmacistHtml = `
        <div class="kv">
          <div class="k">藥師</div>
          <div class="v">每節津貼 <b>${moneyPlain(c.pSession)}</b> 元；處方津貼 <b>${moneyPlain(c.pRx)}</b> 元</div>
        </div>
      `;
    }

    // 助理：只有存在時才顯示
    let assistantHtml = "";
    if (c.a > 0){
      assistantHtml = `
        <div class="kv">
          <div class="k">助理</div>
          <div class="v">每節津貼 <b>${moneyPlain(c.aSession)}</b> 元；處方津貼 <b>${moneyPlain(c.aRx)}</b> 元</div>
        </div>
      `;
    } else {
      assistantHtml = `<div class="mini" style="margin-top:8px;">助理：無</div>`;
    }

    cell.innerHTML = `
      <div class="summaryBox">
        <div class="${pillClass}">門檻：${c.threshold} 張｜超額：${c.over} 張</div>

        ${pharmacistHtml}
        ${assistantHtml}

        <div class="mini" style="margin-top:10px;">規則：${c.ruleLabel}</div>
      </div>
    `;
  }

  function collectAllRows(){
    const rows = Array.from(tbody.querySelectorAll("tr"));
    return rows.map(tr => ({
      shift: tr.querySelector(".shift").value,
      doctors: Number(tr.querySelector(".doctors").value),
      p: Number(tr.querySelector(".pCount").value || 0),
      a: Number(tr.querySelector(".aCount").value || 0),
      t: Number(tr.querySelector(".tCount").value || 0),
      rx: Number(tr.querySelector(".rx").value || 0),
    }));
  }

  function buildShareUrl(){
    const data = { v: 1, rows: collectAllRows() };
    const encoded = encodeData(data);
    const url = new URL(window.location.href);
    url.searchParams.set("data", encoded);
    return url.toString();
  }

  function makeRow(defaultShift="早", preset=null){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td data-label="診次">
        <select class="shift">
          <option ${defaultShift==="早"?"selected":""}>早</option>
          <option ${defaultShift==="午"?"selected":""}>午</option>
          <option ${defaultShift==="晚"?"selected":""}>晚</option>
        </select>
      </td>

      <td data-label="醫師數">
        <select class="doctors">
          <option value="1">1（單診）</option>
          <option value="2">2（雙診）</option>
        </select>
      </td>

      <td data-label="上班人次（含快速套用）">
        <div class="three">
          <div>
            <div class="mini" style="margin:0 0 4px;">藥師</div>
            <input class="pCount" type="number" min="0" step="1" value="1" />
          </div>
          <div>
            <div class="mini" style="margin:0 0 4px;">助理</div>
            <input class="aCount" type="number" min="0" step="1" value="1" />
          </div>
          <div>
            <div class="mini" style="margin:0 0 4px;">工讀</div>
            <input class="tCount" type="number" min="0" step="1" value="0" />
          </div>
        </div>

        <div class="quickbar">
          <button class="qbtn small qSingle" type="button">單診1藥1助</button>
          <button class="qbtn small qDA" type="button">雙診1藥1助</button>
          <button class="qbtn small qDB" type="button">雙診2藥</button>
          <button class="qbtn small qDC" type="button">雙診1藥1助1工</button>
        </div>

        <div class="inlineReason"></div>
      </td>

      <td data-label="處方張數">
        <input class="rx" type="number" min="0" step="1" placeholder="輸入張數" />
      </td>

      <td data-label="結果" class="result"></td>

      <td data-label="操作">
        <div class="row-actions">
          <button class="delBtn" title="刪除" type="button">刪除</button>
        </div>
      </td>
    `;

    const shiftSel = tr.querySelector(".shift");
    const doctorsSel = tr.querySelector(".doctors");
    const pInput = tr.querySelector(".pCount");
    const aInput = tr.querySelector(".aCount");
    const tInput = tr.querySelector(".tCount");
    const rxInput = tr.querySelector(".rx");

    // Quick apply
    tr.querySelector(".qSingle").addEventListener("click", ()=>{ setStaff(tr, 1, 1, 1, 0); renderRow(tr); });
    tr.querySelector(".qDA").addEventListener("click", ()=>{ setStaff(tr, 2, 1, 1, 0); renderRow(tr); });
    tr.querySelector(".qDB").addEventListener("click", ()=>{ setStaff(tr, 2, 2, 0, 0); renderRow(tr); });
    tr.querySelector(".qDC").addEventListener("click", ()=>{ setStaff(tr, 2, 1, 1, 1); renderRow(tr); });

    // Preset load
    if (preset){
      shiftSel.value = preset.shift ?? defaultShift;
      doctorsSel.value = String(preset.doctors ?? 1);
      pInput.value = String(preset.p ?? 1);
      aInput.value = String(preset.a ?? 1);
      tInput.value = String(preset.t ?? 0);
      rxInput.value = (preset.rx ?? "") === 0 ? "0" : String(preset.rx ?? "");
    }

    // Events
    shiftSel.addEventListener("change", ()=>renderRow(tr));
    doctorsSel.addEventListener("change", ()=>renderRow(tr));
    pInput.addEventListener("input", ()=>renderRow(tr));
    aInput.addEventListener("input", ()=>renderRow(tr));
    tInput.addEventListener("input", ()=>renderRow(tr));
    rxInput.addEventListener("input", ()=>renderRow(tr));

    tr.querySelector(".delBtn").addEventListener("click", ()=>{ tr.remove(); });

    renderRow(tr);
    return tr;
  }

  addRowBtn.addEventListener("click", ()=>{ tbody.appendChild(makeRow("早")); });
  add3Btn.addEventListener("click", ()=>{
    tbody.appendChild(makeRow("早"));
    tbody.appendChild(makeRow("午"));
    tbody.appendChild(makeRow("晚"));
  });
  clearBtn.addEventListener("click", ()=>{ tbody.innerHTML = ""; });

  copyLinkBtn.addEventListener("click", async ()=>{
    const url = buildShareUrl();
    await copyText(url);
  });

  // Init from URL
  (function init(){
    const params = new URLSearchParams(window.location.search);
    const dataParam = params.get("data");

    if (dataParam){
      try{
        const decoded = decodeData(dataParam);
        if (decoded && decoded.v === 1 && Array.isArray(decoded.rows)){
          tbody.innerHTML = "";
          decoded.rows.forEach(r=>{
            const shift = (r.shift === "早" || r.shift === "午" || r.shift === "晚") ? r.shift : "早";
            tbody.appendChild(makeRow(shift, {
              shift,
              doctors: Number(r.doctors || 1),
              p: Number(r.p || 0),
              a: Number(r.a || 0),
              t: Number(r.t || 0),
              rx: Number(r.rx || 0),
            }));
          });
          if (tbody.querySelectorAll("tr").length === 0) tbody.appendChild(makeRow("早"));
          return;
        }
      }catch(e){}
    }
    tbody.appendChild(makeRow("早"));
  })();
</script>
</body>
</html>
