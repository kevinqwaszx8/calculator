<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>處方加給計算機（自訂上班人次）</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --line:#23304e; --text:#eaf1ff; --muted:#8aa0c7;
      --ok:#7ee3b7; --warn:#ffd27a; --danger:#ffb4b4;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Microsoft JhengHei","PingFang TC","Noto Sans TC",sans-serif;}
    body{margin:0;background:linear-gradient(180deg,#070b14,#0b1220);color:var(--text);}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px 40px;}
    h1{font-size:20px;margin:0 0 10px;}
    .sub{color:var(--muted);font-size:12px;line-height:1.6;margin-bottom:14px;}
    .card{background:rgba(17,26,46,.92);border:1px solid var(--line);border-radius:14px;padding:14px;}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;}
    button{
      cursor:pointer;background:#142044;color:var(--text);
      border:1px solid var(--line);border-radius:10px;padding:10px 12px;
    }
    button.primary{background:#1b2d63;border-color:#2a3e7e;}
    button:hover{filter:brightness(1.08);}
    table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed;}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:13px;vertical-align:top;}
    th{color:var(--muted);font-weight:650;}
    select,input{
      width:100%;padding:9px 10px;border-radius:10px;border:1px solid var(--line);
      background:#0b1326;color:var(--text);outline:none;
    }
    input:focus,select:focus{border-color:#3a4e7a;}
    .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted);}
    .pill.ok{color:var(--ok);}
    .pill.warn{color:var(--warn);}
    .pill.danger{color:var(--danger);}
    .mini{color:var(--muted);font-size:12px;line-height:1.6;margin-top:8px;}
    .row-actions{display:flex;gap:8px;justify-content:flex-end;}
    .row-actions button{padding:8px 10px;}
    .note{color:var(--muted);font-size:12px;margin-top:10px;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;}
    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
    .summaryBox{
      background:#0b1326;border:1px solid var(--line);border-radius:12px;
      padding:10px; line-height:1.65; word-break:break-word;
    }
    .dangerText{color:var(--danger);}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:6px;margin-top:8px;}
    .kv .k{color:var(--muted);}
    .kv .v b{color:var(--text);}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>處方加給計算機（自訂上班人次）</h1>
    <div class="sub">
      每一列代表一個診次（早/午/晚可任意新增）。你可指定：<b>醫師數（1=單診、2=雙診）</b>、<b>藥師/助理/工讀上班人次</b>、處方張數。<br/>
      若人次配置不符合補助原則，或符合你新增的限制（<b>午/晚只有 2 人不符</b>），該診顯示 <b class="dangerText">不符合規則</b> 且不計算。
    </div>

    <div class="card">
      <div class="toolbar">
        <button class="primary" id="addRowBtn">新增一診</button>
        <button id="add3Btn">一鍵新增：早/午/晚</button>
        <button id="clearBtn">清空</button>
        <span class="pill">超額單價：助理 5 / 張、藥師 10 / 張</span>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:90px;">診次</th>
            <th style="width:90px;">醫師數</th>
            <th style="width:250px;">當日上班人次</th>
            <th style="width:110px;">處方張數</th>
            <th>結果（藥師/助理津貼明細）</th>
            <th style="width:90px;"></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="note">
        <b>補助原則（原始規則）</b>
        <div class="mini">
          - 單診（醫師 1 位）：必須 <span class="mono">1 藥師 + 1 助理 + 0 工讀</span><br/>
          - 雙診（醫師 2 位）：允許三種之一：<br/>
          &nbsp;&nbsp;A) <span class="mono">1 藥師 + 1 助理 + 0 工讀</span><br/>
          &nbsp;&nbsp;B) <span class="mono">2 藥師 + 0 助理 + 0 工讀</span><br/>
          &nbsp;&nbsp;C) <span class="mono">1 藥師 + 1 助理 + 1 工讀</span><br/><br/>
          <b>你的新增限制</b><br/>
          - 若 <b>午診</b> 或 <b>晚診</b> 且上班總人數 <span class="mono">(藥師+助理+工讀)=2</span>，視為 <b class="dangerText">不符合規則</b>（不計算）。
        </div>
      </div>
    </div>
  </div>

<script>
  function moneyPlain(n){
    const v = Math.round((Number(n) || 0));
    return v.toLocaleString("zh-Hant-TW");
  }

  function getRuleByStaff(doctors, p, a, t){
    // 回傳：
    // { valid, threshold, stipendA, stipendPEach, label }
    const base = { valid:false, threshold:0, stipendA:0, stipendPEach:0, label:"" };

    if (doctors === 1){
      if (p === 1 && a === 1 && t === 0){
        return {
          valid:true,
          threshold:40,
          stipendA:0,
          stipendPEach:0,
          label:"單診：門檻40；第41張起 助理5/張、藥師10/張；無固定津貼"
        };
      }
      return { ...base, label:"單診必須是 1 藥師 + 1 助理（工讀=0）。" };
    }

    if (doctors === 2){
      // A) 1P1A0T
      if (p === 1 && a === 1 && t === 0){
        return {
          valid:true,
          threshold:50,
          stipendA:250,
          stipendPEach:500,
          label:"雙診A：助理固定250、藥師固定500；門檻50；第51張起 助理5/張、藥師10/張"
        };
      }
      // B) 2P0A0T
      if (p === 2 && a === 0 && t === 0){
        return {
          valid:true,
          threshold:50,
          stipendA:0,
          stipendPEach:500, // 以藥師人次倍計
          label:"雙診B：2藥師；每位藥師固定500；門檻50；第51張起 藥師10/張（以人次倍計）"
        };
      }
      // C) 1P1A1T
      if (p === 1 && a === 1 && t === 1){
        return {
          valid:true,
          threshold:60,
          stipendA:300,
          stipendPEach:500,
          label:"雙診C：助理固定300、藥師固定500；門檻60；第61張起 助理5/張、藥師10/張（工讀=0）"
        };
      }

      return { ...base, label:"雙診配置不符合三種補助原則（1P1A / 2P / 1P1A1T）。" };
    }

    return { ...base, label:"醫師數請選 1 或 2。" };
  }

  function computeRow(tr){
    const shift = tr.querySelector(".shift").value; // 早/午/晚
    const doctors = Number(tr.querySelector(".doctors").value);
    const p = Number(tr.querySelector(".pCount").value || 0);
    const a = Number(tr.querySelector(".aCount").value || 0);
    const t = Number(tr.querySelector(".tCount").value || 0);
    const rx = Number(tr.querySelector(".rx").value || 0);

    // 你的新增限制：午/晚且總人數=2 -> 不符合
    const headcount = p + a + t;
    if ((shift === "午" || shift === "晚") && headcount === 2){
      return {
        valid:false,
        reason:"午診/晚診上班人數只有 2 人，依規則視為不符合。",
        rx, over:0,
        pSession:0, pRx:0, aSession:0, aRx:0
      };
    }

    const rule = getRuleByStaff(doctors, p, a, t);
    if (!rule.valid){
      return {
        valid:false,
        reason:rule.label,
        rx, over:0,
        pSession:0, pRx:0, aSession:0, aRx:0
      };
    }

    const over = Math.max(0, rx - rule.threshold);

    // 分拆顯示：每節津貼 vs 處方津貼（工讀固定0且不顯示）
    const aSession = rule.stipendA * a;
    const aRx = over * 5 * a;

    const pSession = rule.stipendPEach * p;
    const pRx = over * 10 * p;

    return {
      valid:true,
      ruleLabel:rule.label,
      threshold:rule.threshold,
      rx, over,
      pSession, pRx, aSession, aRx
    };
  }

  // ----- UI -----
  const tbody = document.getElementById("tbody");
  const addRowBtn = document.getElementById("addRowBtn");
  const add3Btn = document.getElementById("add3Btn");
  const clearBtn = document.getElementById("clearBtn");

  function makeRow(defaultShift="早"){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <select class="shift">
          <option ${defaultShift==="早"?"selected":""}>早</option>
          <option ${defaultShift==="午"?"selected":""}>午</option>
          <option ${defaultShift==="晚"?"selected":""}>晚</option>
        </select>
      </td>

      <td>
        <select class="doctors">
          <option value="1">1（單診）</option>
          <option value="2">2（雙診）</option>
        </select>
      </td>

      <td>
        <div class="three">
          <div>
            <div class="mini" style="margin:0 0 4px;">藥師</div>
            <input class="pCount" type="number" min="0" step="1" value="1" />
          </div>
          <div>
            <div class="mini" style="margin:0 0 4px;">助理</div>
            <input class="aCount" type="number" min="0" step="1" value="1" />
          </div>
          <div>
            <div class="mini" style="margin:0 0 4px;">工讀</div>
            <input class="tCount" type="number" min="0" step="1" value="0" />
          </div>
        </div>
        <div class="mini" style="margin-top:6px;">
          午/晚若總人數=2，會直接判定不符合。
        </div>
      </td>

      <td>
        <input class="rx" type="number" min="0" step="1" placeholder="輸入張數" />
      </td>

      <td class="result"></td>

      <td>
        <div class="row-actions">
          <button class="delBtn" title="刪除">刪除</button>
        </div>
      </td>
    `;

    const shiftSel = tr.querySelector(".shift");
    const doctorsSel = tr.querySelector(".doctors");
    const pInput = tr.querySelector(".pCount");
    const aInput = tr.querySelector(".aCount");
    const tInput = tr.querySelector(".tCount");
    const rxInput = tr.querySelector(".rx");

    function applyDefaultStaff(){
      const d = Number(doctorsSel.value);
      if (d === 1){
        pInput.value = 1; aInput.value = 1; tInput.value = 0;
      } else {
        // 預設用雙診A：1P1A
        pInput.value = 1; aInput.value = 1; tInput.value = 0;
      }
    }

    function render(){
      const c = computeRow(tr);
      const cell = tr.querySelector(".result");

      if (!c.valid){
        cell.innerHTML = `
          <div class="summaryBox">
            <div class="pill danger">不符合規則</div>
            <div class="mini" style="margin-top:8px;">${c.reason}</div>
          </div>
        `;
        return;
      }

      const pillClass = (c.over > 0) ? "pill warn" : "pill ok";
      cell.innerHTML = `
        <div class="summaryBox">
          <div class="${pillClass}">門檻：${c.threshold} 張｜超額：${c.over} 張</div>

          <div class="kv">
            <div class="k">藥師</div>
            <div class="v">每節津貼 <b>${moneyPlain(c.pSession)}</b> 元；處方津貼 <b>${moneyPlain(c.pRx)}</b> 元</div>

            <div class="k">助理</div>
            <div class="v">每節津貼 <b>${moneyPlain(c.aSession)}</b> 元；處方津貼 <b>${moneyPlain(c.aRx)}</b> 元</div>
          </div>

          <div class="mini" style="margin-top:10px;">
            規則：${c.ruleLabel}
          </div>
        </div>
      `;
    }

    // events
    shiftSel.addEventListener("change", render);
    doctorsSel.addEventListener("change", ()=>{ applyDefaultStaff(); render(); });
    pInput.addEventListener("input", render);
    aInput.addEventListener("input", render);
    tInput.addEventListener("input", render);
    rxInput.addEventListener("input", render);

    tr.querySelector(".delBtn").addEventListener("click", ()=>{
      tr.remove();
    });

    applyDefaultStaff();
    render();
    return tr;
  }

  addRowBtn.addEventListener("click", ()=>{
    tbody.appendChild(makeRow("早"));
  });

  add3Btn.addEventListener("click", ()=>{
    tbody.appendChild(makeRow("早"));
    tbody.appendChild(makeRow("午"));
    tbody.appendChild(makeRow("晚"));
  });

  clearBtn.addEventListener("click", ()=>{
    tbody.innerHTML = "";
  });

  // 初始：先給一列
  tbody.appendChild(makeRow("早"));
</script>
</body>
</html>
